# Alembic Database Migrations

This directory contains Alembic migration scripts for the NEXUS Platform database.

## Setup

Alembic is already configured. The migration environment is set up to work with PostgreSQL.

## Common Commands

### Create a new migration (autogenerate)
```bash
alembic revision --autogenerate -m "description of changes"
```

### Create a blank migration
```bash
alembic revision -m "description of changes"
```

### Apply all pending migrations
```bash
alembic upgrade head
```

### Rollback one migration
```bash
alembic downgrade -1
```

### Rollback to a specific revision
```bash
alembic downgrade <revision_id>
```

### View migration history
```bash
alembic history
```

### View current revision
```bash
alembic current
```

### Show SQL for migrations (without executing)
```bash
alembic upgrade head --sql
```

## Migration Workflow

1. **Make changes to models** in `database/models.py`

2. **Generate migration**:
   ```bash
   alembic revision --autogenerate -m "Add new field to User model"
   ```

3. **Review the generated migration** in `database/alembic/versions/`
   - Alembic will try to detect changes automatically
   - Always review the generated code before applying
   - Add custom logic if needed (data migrations, etc.)

4. **Apply the migration**:
   ```bash
   alembic upgrade head
   ```

5. **Commit the migration file** to version control

## Environment Variables

Set `DATABASE_URL` environment variable to override the default database connection:

```bash
export DATABASE_URL="postgresql://user:password@host:port/dbname"
```

## Best Practices

1. **Always review autogenerated migrations** - Alembic can't detect everything
2. **Test migrations** in development before applying to production
3. **Write reversible migrations** - Always implement both `upgrade()` and `downgrade()`
4. **One logical change per migration** - Don't combine unrelated changes
5. **Use descriptive migration messages** - Makes history easier to understand
6. **Keep data migrations separate** - Complex data transformations should be in their own migrations

## Initial Migration

The initial migration creates all tables from scratch. If you need to reset:

```bash
# Drop all tables
python database/init_db.py drop

# Run migrations to recreate
alembic upgrade head
```

## Troubleshooting

### Migration conflicts
If you have migration conflicts (multiple heads):
```bash
alembic merge heads -m "merge multiple heads"
```

### Reset to clean state
```bash
alembic downgrade base  # Rollback all migrations
alembic upgrade head     # Reapply all migrations
```

### Check for pending migrations
```bash
alembic current
alembic history
```

The current revision should match the latest in history.
